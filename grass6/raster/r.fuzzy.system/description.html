<h2>OPTIONS</h2>

<dl>
<dt><b>maps</b></dt>
<dd>A text file containing maps name and fuzzy sets connected with map
definition. The input maps (indicated with % in text file) must be found
in the search path.
The output map name is the output name parameter. In map file
output map is marked by special name <b>_OUTPUT_</b>  If maps are in different
mapsets the name require @. Map names in database cannot contain following
symbols: <b> %,$ and #</b>. Every map name must start with map name
identifier:<b> %</b>. Every set definition connected with cetrain map must
follow the map name and must start with set identifier :<b> $</b>. The set
definition must be in braces { } and requires parameters separated by semicolon.
Any whitespaces like spaces, tabs, empty lines are allowed and may used to
visual format of rule file.

<div class="code"><pre>$ set_name {side; points; boundary_shape; hedge; height }</pre></div>
<ul>
<li><b>set_name</b>: Any name of the fuzzy set. Must not contain symbols: <i>
%,$ and #</i>
<li><b>side</b>: Option indicate if set is fuzzified of both sides (both), left
or right side. Available: <i>both, left, right</i>. 
<li><b>points</b>: A list containing 4 (A,B,C,D) or 2 A,B) points separated by
comma. Points definine  location of sets of boundaries. Points may not to be in
map range, but it may lead to only 0 o 1 membership for the whole map. For
"both" side parameters range between A and D defines base, but range between B
and C core of the fuzzy set. Between A and B and C and D are set's boundaries.
If side is "both" it require 4 points, else 2 points. Points values must be
not-decreasing.
<li><b>shape</b>: Parameter definied the shape of the fuzzy boundary. Available:
<i>sshaped, linear, jshaped, gshaped</i>. The same boundaires are appled to 
both sides of fuzzy set.
<li><b>hedge</b>: Shape modifier the positive number means dilatation (power the
fuzzy set by 2) the negative means concetration (square root of fuzzy set). The
number means number of dilatation/concetration applied on fuzzy set.
<li><b>height</b>: Height modifier. Range from 0 to 1. The  value 1 and indicate
full membership beteen points B and C. If height is lesser than one the maximum
memebrship is equal to height.
</ul>
<p>An example of fuzzy sets definiton:
<div class="code"><pre>$ moderate {both; 90,100,120,130; sshaped; 0; 1}</pre></div>

<b>Special notes about sets definition for output map:</b><br>
These sets shall be created as triangular (both sides) sets with linear
boundaries, without hedge and height modifiers:
<div class="code"><pre>$ moderate {both; 0,20,20,40; linear; 0; 1}</pre></div>
</dd>

<dt><b>rules</b></dt>
<dd>A text file containing rules for classification.Th typical fuzzy rule
consists of one or more antecedents and one consequent:

<div class="code"><pre>IF elev IS high AND distance IS low THEN probability IS small

where:
antecetends: elev IS high; distance IS low
consequent: probability IS small
</pre></div>

The rule file has his own syntax. Because module creates only one result map,
the map name is ommited. Every rule starts with $ and consist of consequent name
and antecedents in braces { }. All maps and sets used in atecednets must be
included in the maps file. At the begining of the calculation program checks if
all names and sets are included in maps file. Names of the rules must be same as
sets names of the output map. The rules file use following symbols:
<ul>
<li>IS is symbolised by <b>=</b>
<li>IS NOT is symbolised by <b>~</b>
<li>AND is symbolised by <b>&</b>
<li>OR is symbolised by <b>|</b>
<li>To  specify the order of operators must use parentheses <b>()</b>.
</ul>


<p>An example of fuzzy rules definiton:
<div class="code"><pre>
$ small {distance = high & elev = high}
</pre></div>

</dd>
</dl>
<h2>ADVANCED OPTIONS</h2>
In most cases default options shoud not be changed.
<dl>
<dt><b>family</b></dt>
<dd>AND and OR operations in fuzzy logic are made with T-norms, T-conorms.
T-norms, T-conorms are a generalization of the two-valued logical conjunction
and  disjunction  used by boolean logic, for fuzzy logics. Because there is more
than one possible generalisation of logial operations, r.fuzzy.system provides 6
most popular families for fuzzy operations:
<ul>
<li><b>Zadeh</b> with minimum (Godel) t-norm and maximum T-conorm;
<li><b>product</b> with product T-norm and probabilistic sum as T-conorm;
<li><b>drastic</b> with drastic T-norm and drastic T-conorm;
<li><b>Lukasiewicz</b> with Lukasiewicz T-norm and bounded sum as a T-conorm;
<li><b>Fodor</b> with nilpotent minimum as T-norm and nilpotent maximum as
T-conorm;
<li><b>Hamacher</b> (simplified) with Hamacher product as T-norm and Einstein
sum as T-conorm;
</ul>
<p>
<TABLE cellspacing=4>
<TR><TH>Family</TH><TH> T-NORM (AND) </TH><TH>T CONORM (OR) </TH></TR>
<TR><TD>ZADEH</TD><TD> MIN(x,y)</TD><TD>MAX(x,y)</TD></TR>
<TR><TD>PRODUCT</TD><TD>	x*y	</TD><TD>x + y -x * y</TD></TR>
<TR><TD>DRASTIC	</TD><TD>IF MAX(x, y) == 1 THEN MIN(x, y) ELSE 0
</TD><TD>IF (MIN(x, y) == 0) THEN MAX(x, y) ELSE 1</TD></TR>
<TR><TD>LUKASIEWICZ</TD><TD>	MAX((x+y-1),0)</TD><TD>	MIN((x+y),1)</TD></TR>
<TR><TD>FODOR	</TD><TD>IF (x+y)>1 THEN MIN(x,y) ELSE 0	</TD><TD>IF
(x+y<1) THEN MAX(x,y) ELSE 1</TD></TR>
<TR><TD>HAMACHER</TD><TD>	IF (x==y==0) THEN 0 ELSE
(x*y)/((x+y)-x*y)</TD><TD>	(x+y)/(1+x*y)</TD></TR>
</TABLE>
</dd>
<dt><b>imp: implication </b></dt>
<dd>Imlication determines the method of reshapening of consequents (fuzzy set)
by antecedents (single value) : 
<ul>
<li><b>minimum</b> means the lowest value of the antecedtents and output set
definition. It usually creates trapezoidal consequent set definition.
<li><b>product</b> means the multiplication of the antecedtents and output set
definition. It usually creates triangular consequent set definition.
</ul>
</dd>
<dt><b>defuzz: defuzzification method</b></dt>
<dd>Before defuzzification all consequents are agregated into one fuzzy set.
Defuzzification is the process of conversion of aggregated fuzzy set into one
crisp value. The r.fuzzy.system provides 5 methods of defuzzification:
<ul>
<li><b>centroid</b> center of mass of the fuzzy set (in practise weighted mean);
<li><b>bisector</b> a value which divide fuzzy set on two parts of equal area;
<li><b>min</b> min (right limit) of highest part of the set;
<li><b>mean</b> mean (center) of highest part of the set;
<li><b>max</b> max (left limit) of highest part of the set;
</ul>
</dd>
<dt><b>res: universe resolution</b></dt>
<dd>The universe is an interval between the lowest and highest values of
consequent and agregated fuzzy sets. The resolution provides number of elements
of these fuzzy sets. The minimum and maximum for univese is taken from the
minimal and maximal values of fuzzy set definition of output map Because it has
strong impact on computation time and precision of defuzzification, values lower
than 30 may impact on precision of final result, but values above 200 may slow
down computation time.
</dd>
</dl>
<h2>VISUAL OUTPUT</h2>
<dl>
<dt><b>coordinates</b></dt>
<dd>Coordinates of points for which output: universe, all consequents sets and
agregate set. It is useful for visual presentation or detail analysis of fuzzy
rules behaviour. In that cases calculations are peroforemd n=only for selected
point.</dd>
<dt><b>membership only flag</b></dt>
<dd>Prints for all maps sat of values in map range (map universe) and values of
fuzzy sets (linguistic values). Number of values is taken from resolution
(default 100). This option is useful for visual control fuzzy set definitions
for every map.</dd>
</dl>

<h2>OUTPUTS</h2>
<dl>
<dt><b>output</b></dt>
<dd>Map containing defuzzified values. Map is always of type FCELLS and contains
values defined in output universe.
</dd>
<dt><b>multipe output flag</b></dt>
<dd>This flag is used to create fuzzified maps for every rule. The name of the
map consist of otput map name, '_' and rule name (for example: output=probs and
rule name high, the map name: probs_high). Values of maps ranges from 0  to 1.
If map with such name exists will be overwritten without warning.
</dd>
</dl>
<h2>NOTES</h2>
<h4>Calculation of boundary shape</h4>
Depending on type of the boundary different equation are used to determine its
shape:
<p>
<b>Linear:</b> the membership is calculated according following equation:<br>

<div class="code"><pre>
value  <=  A -> x = 0
A< value > B -> x = (value-A)/(B-A)
B <= value >= C -> x = 1
C< value > D -> x = (D-value)/(D-C)
value  >=  D -> x = 0
</pre></div>
<b>S-shaped, G-shaped and J shaped:</b>  use following equation to sommoth
boundary:
<div class="code"><pre>
sin(x * Pi/2)^2 (for S-shaped)
tan(x * Pi/4)^2 (for J-shaped)
tan(x * Pi/4)^0.5 (for G-shaped)

where:
x current fuzzy value
A,B,C,D inflection point
</pre></div>

<h4>Category information</h4>
Every cell has a category information showing the membership of result map in
any reslut's fuzzy values: for example moderate=0.60, high=0.40 means that cell
belongs to moderate class with 0.60 membership and high class with membership =
0.40. The membership is calculated based on _OUTPUT_ definition.

<h2>EXAMPLE</h2>
<p>
Fuzzy sets are sets whose elements have degrees of membership. Zadeh (1965)
introduced Fuzzy sets as an extension of the classical notion of set. Classical 
membership of elements in a set are binary terms: an element either belongs or
does not belong to the set. Fuzzy set theory use the gradual membership of
elements in a set. A membership function use values in the real unit interval
[0, 1]. Classical sets, are special cases of the membership functions of fuzzy
sets and only take values 0 or 1. Classical sets are in fuzzy set theory usually
called crisp sets. The fuzzy set theory can be used in a wide range of domains
in which information is  imprecise, such as most of the GIS operations.
<p>
Suppose we want to determine the flood risk on some area (Spearfish dataset)
using two maps: distance to streams and elevation above streams. We can write
some common sense rules:
<div class="code"><pre>
IF elevation IS low AND distance IS near THEN risk IS very probable
IF elevation IS low OR distance IS near THEN risk IS probable
IF elevation IS high AND distance IS far THEN risk IS unprobable
</pre></div>
In clasical boolean sense, we would taken some limits of ideas "near" "far" etc,
but what about walues near the limit? The fuzzy set uses partial memberships
which abolish these restrictions. In that sense to set "near" belongs all areas
with distance no more than 100 m with full membership and from 100 to 200 m with
partial membership greater than 0. Over 200 m we can assume that is not near.
This allow to formulate fuzzy rules for distance map:
<div class="code"><pre>
near: BELOW 100 = 1; FROM 100 TO 200 = {1 TO 0}; ABOVE 200 = 0;
</pre></div>

To recive final map program calculate partial fuzzy set for all rules and next
agregate it into one fuzzy set. These fuzzy sets are created on value sequence
called universe. Every set has the number of elements equal to universe
resolution. Such set cannot be stored as map so finally is defuzzified with
method choosen by user.
<p>
First we need two maps created with r.stream package:

<!-- TODO: update to GRASS 7 version -->
<div class="code"><pre>
r.watershed -f elevation=elevation.10m accumulation=accum
r.mapcalc "accum_abs = abs(accum)"
r.stream.extract elevation=elevation.10m threshold=1000 \
         stream_rast=streams direction=dirs
r.stream.order stream=streams dir=dirs horton=horton
r.mapcalc "horton3 = if(horton>2,1,0)"
r.stream.distance stream=horton3 dir=dirs dem=elevation.10m \
         distance=distance elevation=elevation
</pre></div>

Next, to perform analysis we need two files: one with definition of map used in
analysis and definition of fuzzy sets for every map, and second with fuzzy
rules. For this example:

<p>MAPS

Note: the raster map names are specified with a "%" character (here 
"%elevation" and "%distance" are the input maps and "%flood" the
output map:

<div class="code"><pre>
#flood.map
	%elevation
$ low {right; 2,4; sshaped; 0; 1}
$ moderate {both; 2,4,5,10; sshaped; 0; 1}
$ high {left; 5,10; sshaped; 0; 1}

	%distance
$ near {right; 30,70; sshaped; 0; 1}
$ medium {both; 30,70,100,150; sshaped; 0; 1}
$ far {both; 100,150,200,300; sshaped; 0; 1}
$ veryfar {left; 200,300; sshaped; 0; 1}

	%accum_abs
$ low {right; 500,5000; sshaped; 0; 1}
$ $ high {left; 500,5000; sshaped; 0; 1}

#output map

	%_OUTPUT_
$ none {both; 0,20,20,40; linear; 0;1}
$ low {both; 20,40,40,60; linear; 0;1}
$ moderate {both; 40,60,60,80; linear; 0;1}
$ high {both; 60,80,80,100; linear; 0;1}
$ veryhigh {both; 80,100,100,120; linear; 0;1}
</pre></div>

<p>RULES:
<div class="code"><pre>
#flood.rul
$ none {distance = veryfar | elevation = high}
$ low {distance ~ near & accum_abs = high}
$ moderate {(distance = medium | distance = far) & (elevation = low | elevation
= moderate)}
$ high {(distance = medium & elevation = low)|(distance = near & elevation =
moderate)}
$ veryhigh {distance = near & elevation = low}
</pre></div>

finally we need run r.fuzzy.system:
<div class="code"><pre>
A) r.fuzzy.system maps=flood.map rules=flood.rul family=Zadeh defuz=centroid
imp=minimum res=100 output=flood_z_cent
B) r.fuzzy.system maps=flood.map rules=flood.rul family=drastic
defuz=max_of_highest imp=minimum res=100 output=flood_d_max
C) r.fuzzy.system maps=flood.map rules=flood.rul family=Hamacher
defuz=mean_of_highest imp=minimum res=100 output=flood_h_mean
</pre></div>

Resulting map should look like this below.
<CENTER><img src="f_result.png" border="1"></CENTER><br>

<h2>SEE ALSO</h2>

<em>
<a href="r.fuzzy.html">r.fuzzy</a>,
<a href="r.fuzzy.logic.html">r.fuzzy.logic</a>,
<a href="r.fuzzy.set.html">r.fuzzy.set</a>,
<a href="r.mapcalc.html">r.mapcalc</a>
</em>

<h2>REFERENCES</h2>

Zadeh, L.A. (1965). "Fuzzy sets". Information and Control 8 (3): 338â€“353.
doi:10.1016/S0019-9958(65)90241-X. ISSN 0019-9958.<p>

Nov&aacute;k, Vil&eacute;m (1989). Fuzzy Sets and Their Applications. Bristol: Adam Hilger.
ISBN 0-85274-583-4.<p>

Klir, George J.; Yuan, Bo (1995). Fuzzy sets and fuzzy logic: theory and
applications. Upper Saddle River, NJ: Prentice Hall PTR. ISBN 0-13-101171-5.<p>

Klir, George J.; St Clair, Ute H.; Yuan, Bo (1997). Fuzzy set theory:
foundations and applications. Englewood Cliffs, NJ: Prentice Hall. ISBN
0133410587.<p>

Meyer D, Hornik K (2009a). \Generalized and Customizable Sets in R." Journal of
Statistical Software, 31(2), 1{27. URL http://www.jstatsoft.org/v31/i02/.<p>

Meyer D, Hornik K (2009b). sets: Sets, Generalized Sets, and Customizable Sets.
R~package version~1.0, URL http://CRAN.R-project.org/package=sets.<p>

<h2>AUTHOR</h2>
Jarek Jasiewicz

<p><i>Last changed: $Date$</i>
